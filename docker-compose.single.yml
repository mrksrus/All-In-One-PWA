version: '3.8'

# Single-container setup using root Dockerfile
# This runs both frontend and backend in one container
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: all-in-one-pwa
    ports:
      # Format: "HOST_PORT:CONTAINER_PORT"
      # Change APP_HOST_PORT in .env file to change the host port
      - "${APP_HOST_PORT:-3000}:${APP_CONTAINER_PORT:-3000}"
    environment:
      - NODE_ENV=production
      # App container port - change APP_CONTAINER_PORT in .env if needed
      - PORT=${APP_CONTAINER_PORT:-3000}
      # Secrets are auto-generated on first run and stored in /data/secrets.env
      # Can be overridden with environment variables if needed
      - JWT_SECRET=${JWT_SECRET:-}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET:-}
      - DB_PATH=/data/database.sqlite
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}
    volumes:
      # Persistent volume for all data (database, secrets, future: email attachments, uploads)
      - ./data:/data
    restart: unless-stopped
